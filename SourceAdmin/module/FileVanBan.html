<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <base>

    <link rel="stylesheet" href="/GiaoDienAdmin/dist/css/AdminLTE.min.css">
    <link href="/GiaoDienAdmin/bootstrap/css/sweetalert2.min.css" rel="stylesheet" />
    <link href="/GiaoDienAdmin/bootstrap/css/alter.css" rel="stylesheet" />

    <link href="/GiaoDienAdmin/bootstrap/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/GiaoDienAdmin/bootstrap/css/ionicons.min.css" rel="stylesheet" />

    <script src="/GiaoDienAdmin/plugins/jQuery/jquery-2.2.3.min.js"></script>
    <link href="/GiaoDienAdmin/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/GiaoDienAdmin/cssFolder/corecss.css" rel="stylesheet" />


    <link href="/GiaoDienAdmin/cssFolder/csschiakhung.css" rel="stylesheet" />
    <link href="/GiaoDienAdmin/cssFolder/window.css" rel="stylesheet" />
    <link href="/GiaoDienAdmin/cssFolder/windowall.css" rel="stylesheet" />
    <link href="/GiaoDienAdmin/cssFolder/jtreecsssss.css" rel="stylesheet" />
    <style>
        #dragTree {
            padding: 10px;
        }

        .content {
            padding-top: 50px !important;
        }

        .btn-block + .btn-block {
            margin: 0px !important;
        }

        .btn-block {
            display: inherit !important;
            width: inherit !important;
        }

        .modal-dialog {
            width: 300px !important;
            margin: 150px auto !important;
        }

        .x-item-textbox {
            width: 96px;
            border: none;
            text-align: center;
        }

        .panel-right {
            padding: 0px !important;
        }

        .nav-tabs-custom {
            box-shadow: none !important;
        }

        .x-grid-body {
            border-width: 0px;
            border-style: none !important;
        }

        #chiasesudung {
            padding-top: 10px;
        }
    </style>

</head>
<body>
    <section class="content">
        <div class="panel-container">
            <div class="panel-left  box box-primary ">
                <div class="box-header with-border">
                    <h3 class="box-title">THƯ MỤC TÀI LIỆU</h3>
                </div>
                <div id="dragTree">
                </div>
            </div>
            <div class="splitter">
            </div>
            <div class="panel-right">

                <div class="row">
                    <div class="col-md-12">
                        <div class="nav-tabs-custom">
                            <ul class="nav nav-tabs" id="ulmenu">
                                <li class="active" id="lidanhsach"><a href="#danhsachanhhienthi" data-toggle="tab" aria-expanded="false"><i class="fa  fa-list-ul iconTab"></i>Danh sách file từ server</a></li>
                                <li class="" id="liaddnew" style="display: none"><a href="#uploadvaothumuc" data-toggle="tab" aria-expanded="false"><i class="fa fa-edit iconTab"></i>Chọn file từ desktop</a></li>
                            </ul>
                            <div class="tab-content" id="frmnoidung">
                                <div class="tab-pane active box-body" id="danhsachanhhienthi">
                                    <div class="nav-tabs-custom">

                                        <div class="x-panel x-fit-item x-panel-default" style="width: 100%; height: 700px; margin: 0px;" role="presentation" id="fileManager">
                                            <div id="fileManager-bodyWrap" data-ref="bodyWrap" class="x-panel-bodyWrap" role="presentation">
                                                <div id="fileManager-body" data-ref="body" class="x-panel-body x-panel-body-default x-border-layout-ct x-panel-body-default x-docked-noborder-top x-docked-noborder-right x-docked-noborder-bottom x-docked-noborder-left" role="presentation" style="width: 100%; height: 100%; left: 0px; top: 0px;">
                                                    <div class="x-container x-border-item x-box-item x-container-default" style="border-width: 0px; margin: 0px; width: 100%; right: auto; /* left: 205px; *//* top: 190px; */height: 100%;" role="presentation" id="ext-comp-1065">
                                                        <div class="x-component x-dataview x-unselectable x-grid-body x-fit-item x-component-default x-scroller" role="listbox" aria-hidden="false" aria-disabled="false" aria-multiselectable="true" id="dataview-1066" tabindex="0" data-componentid="dataview-1066" style="overflow: auto; margin: 0px; width: 100%; height: 100%;">
                                                            <ul class="x-items" id="dataimages"></ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div class="tab-pane " id="uploadvaothumuc" style="    min-height: 400px;padding-top:20px">
                                    <form class="form-horizontal">
                                        <div class="form-group">
                                            <div class="col-sm-9">
                                                <input type="file" id="anhdaidien" accept="application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/pdf" title="Chọn file từ máy tính (Dung lượng < 10 Mb)" />
                                                <div class="" style="padding-top: 15px">
                                                    <div id="thongtin" class="col-sm-12">
                                                        <h5 id="name-vid"></h5>
                                                        <p id="size-vid"></p>
                                                        <p id="type-vid"></p>
                                                        <p id="kicthuoc" style="display: none"></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-sm-3">
                                                <button type="button" class="btn btn-primary btn-flat IconButtonPage" id="btnUploadFile"><i class="fa fa-upload iconButtonPage" aria-hidden="true"></i>Upload</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    <script src="/GiaoDienAdmin/bootstrap/js/sweetalert2.js"></script>
    <script src="/GiaoDienAdmin/bootstrap/js/alter.js"></script>
    <script src="/GiaoDienAdmin/bootstrap/js/commonAlter.js"></script>

    <script src="/GiaoDienAdmin/cssFolder/jtreemin.js"></script>
    <script src="/GiaoDienAdmin/cssFolder/jquery-sezizable.js"></script>
    <script src="/GiaoDienAdmin/cssFolder/windowall.js"></script>
    <script src="/SourceAdmin/js/JavaScriptXuLyAdmin.js"></script>

    <script type="text/javascript">
        var linkWebC50 = window.location.origin;
        var stringTookenServer;
        $(document).ready(function () {
            $.getJSON('/SourceAdmin/ashx/XuLyAdmin.ashx', { type: 'getTookenByServer' }, function (danhsach) {
                stringTookenServer = "";
                if (danhsach != "") {
                    stringTookenServer = danhsach.tooken;
                }
                else {
                    stringTookenServer = "tooken fail";
                }
            });
        });

        $('#liaddnew').click(function () {
            $(this).addClass('active');
            $('#uploadvaothumuc').addClass('active');
            $('#danhsachanhhienthi').removeClass('active');
            $('#lidanhsach').removeClass('active');
        });
        $('#lidanhsach').click(function () {
            $('#lidanhsach').addClass('active');
            $('#danhsachanhhienthi').addClass('active');

            $('#liaddnew').removeClass('active');
            $('#uploadvaothumuc').removeClass('active');

            hienthidanhsachanhtheothumuc();
        });

        $("#anhdaidien").change(function () {
            renderFileOther(this.files[0])

        });

        $(".panel-left").resizable({
            handleSelector: ".splitter",
            resizeHeight: false
        });
        $(".panel-top").resizable({
            handleSelector: ".splitter-horizontal",
            resizeWidth: false
        });


        var $menuthumuc = $('#dragTree');
        var $dragTree = $('#dragTree');
        $menuthumuc.jstree({
            'core': {
                'data': {
                    'url': function (node) {
                        return node.id === '#' ? '/SourceAdmin/ashx/XuLyAdmin.ashx?type=loaddanhsachthumucTailieu&id_tm=0' : '/SourceAdmin/ashx/XuLyAdmin.ashx?type=loaddanhsachthumucTailieu&id_tm=' + node.id;
                    },
                    'data': function (node) {
                        return { 'id': node.id };
                    }
                },
                'check_callback': function (o, n, p, i, m) {
                    if (m && m.dnd && m.pos !== 'i') { return false; }

                    if (o === "move_node" || o === "copy_node") {
                        if (this.get_node(n).parent === this.get_node(p).id) { return false; }
                    }
                    return true;
                },
                'themes': {
                    'responsive': false
                }
            },
            'sort': function (a, b) {
                return this.get_type(a) === this.get_type(b) ? (this.get_text(a) > this.get_text(b) ? 1 : -1) : (this.get_type(a) >= this.get_type(b) ? 1 : -1);
            },
            'types': {
                'default': {
                    'icon': 'fa fa-folder'
                },
                'file': {
                    'icon': 'fa fa-file'
                }
            },
            'unique': {
                'duplicate': function (name, counter) {
                    return name + ' ' + counter;
                }
            },
            'plugins': ['state', 'dnd', 'sort', 'types', 'unique']
        }).bind('select_node.jstree', function (e, data) {
            var _idthumuc = "";
            var node_selected = $('#dragTree').jstree('get_selected', true);
            var idPar = node_selected[0].parent;
            var idMe = node_selected[0].id;

            if (idPar == "#" && idMe == 3) {
                $('#lidanhsach').addClass('active');
                $('#danhsachanhhienthi').addClass('active');
                $('#liaddnew').removeClass('active');
                $('#uploadvaothumuc').removeClass('active');

                danhsachFilechiase();
            }
            else {
                danhsachFiletheothumuc();
            }
        })

        function danhsachFiletheothumuc() {
            $('#liaddnew').removeAttr('style');
            var node_selected = $('#dragTree').jstree('get_selected', true);
            var idPar = node_selected[0];
            var _idthumuc = idPar.id;
            var tableIMG = $.getJSON('/SourceAdmin/ashx/XuLyAdmin.ashx', { type: 'danhsachdulieutrongthumuc', _idthumuc: _idthumuc }, function (kq) {
                var $ul = $("#dataimages");
                $ul.empty();
                var idex = 0;
                var check = true;

                kq.data.forEach(function (item) {

                    var iconFile = "";
                    if (item.mimetype == "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                        iconFile = "iconFile.png";
                    }
                    else if (item.mimetype == "application/pdf") {
                        iconFile = "pdf.jpg";
                    }
                    else if (item.mimetype == "application/msword") {
                        iconFile = "word.png";
                    } else {
                        iconFile = "fileOther.jpg";
                    }
                    var li = $('<li/>', {
                        class: 'x-item x-layout-largeicons',
                        html: "<span class='x-item-icon' id='ext-element-22'>\
                            <span class='x-item-thumbnail'>\
                                  <div id='embedURL' class='html5gallery' data-html5player='true' data-fancybox data-src='http://docs.google.com/viewer?embedded=true&url=" + linkWebC50 + item.duongdanfile + "' data-webm='" + item.duongdanfile + "' data-title='" + item.tenfile + "'>\
                                    <img class='b-lazy b-loaded x-select-target' src='/ThuMucGoc/AnhDaiDien/"+ iconFile + "' width='90px' height='90px' id='ext-element-21'>\
                                  </div>\
                            </span>\
                        </span>\
                        <input class='x-item-textbox' value='" + item.tenfile + "' readonly type='text' data-chilimage='" + JSON.stringify(item) + "' id='tenfile" + (item.id_quanlyfileupload) + "'></input>"
                    }).appendTo($ul);
                    li.hover(function () {
                        li.toggleClass('x-item-over');
                    });
                    li.click(function () {
                        _idfile = item.id_quanlyfileupload;
                        $ul.find('li.x-item-selected').removeClass('x-item-selected');
                        li.toggleClass('x-item-selected');
                    });
                    li.dblclick(function () {
                        window.opener.getLinkFile(item.duongdanfile);
                        window.close();
                    });

                    idex++;
                });
            });
        }
        function danhsachFilechiase() {
            $('#liaddnew').attr('style', 'display:none')
            var tableIMG = $.getJSON('/SourceAdmin/ashx/XuLyAdmin.ashx', { type: 'danhsachtailieuduocchiase' }, function (kq) {
                var $ul = $("#dataimages");
                $ul.empty();
                var idex = 0;
                var check = true;

                kq.data.forEach(function (item) {

                    var iconFile = "";
                    if (item.mimetype == "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                        iconFile = "iconFile.png";
                    }
                    else if (item.mimetype == "application/pdf") {
                        iconFile = "pdf.jpg";
                    }
                    else if (item.mimetype == "application/msword") {
                        iconFile = "word.png";
                    } else {
                        iconFile = "fileOther.jpg";
                    }

                    var li = $('<li/>', {
                        class: 'x-item x-layout-largeicons',
                        html: "<span class='x-item-icon' id='ext-element-22'>\
                            <span class='x-item-thumbnail'>\
                                  <div id='embedURL' class='html5gallery' data-html5player='true' data-fancybox data-src='http://docs.google.com/viewer?embedded=true&url=" + linkWebC50 + item.duongdanfile + "' data-webm='" + item.duongdanfile + "' data-title='" + item.tenfile + "'>\
                                    <img class='b-lazy b-loaded x-select-target' src='/ThuMucGoc/AnhDaiDien/"+ iconFile + "' width='90px' height='90px' id='ext-element-21'>\
                                  </div>\
                            </span>\
                        </span>\
                        <input class='x-item-textbox' value='" + item.tenfile + "' readonly type='text' data-chilimage='" + JSON.stringify(item) + "' id='tenfile" + (item.id_quanlyfileupload) + "'></input>"
                    }).appendTo($ul);

                    li.hover(function () {
                        li.toggleClass('x-item-over');
                    });
                    li.click(function () {
                        _idfile = item.id_quanlyfileupload;
                        $ul.find('li.x-item-selected').removeClass('x-item-selected');
                        li.toggleClass('x-item-selected');
                    });
                    li.dblclick(function () {
                        window.opener.getLinkFile(item.duongdanfile);
                        window.close();
                    });
                    idex++;
                });
            });
        }

        $('#btnUploadFile').click(function () {
            var check = true;
            _idthumuc = "";
            var node_selected = $('#dragTree').jstree('get_selected', true);
            _idthumuc = node_selected[0].id;

            var anhdaidien = $('#anhdaidien').val();
            var dungluong = $('#kicthuoc').text();
            var tenfile = $('#name-vid').text();

            var fd_data = new FormData();

            fd_data.append('type', 'uploadFileTaiLieuServer');
            fd_data.append('fileanh', $('#anhdaidien')[0].files[0]);
            fd_data.append('_idthumuc', _idthumuc);
            fd_data.append('dungluong', dungluong);
            fd_data.append('stringTookenClient', stringTookenServer);

            if (anhdaidien == "") {
                check = false;
                $loading.remove();
                common.showNotification('top', 'right', 'Mời bạn chọn file cần upload');
            } else if (_idthumuc == "") {
                check = false;
                $loading.remove();
                common.showNotification('top', 'right', 'Mời bạn chọn folder');
            } else if (!valTextboxValue(tenfile)) {
                check = false;
                $loading.remove();
                common.showNotification('top', 'right', 'Tên folder không chứa ký tự đặc biệt ');
            }

            if (check) {
                $.ajax({
                    type: "POST",
                    url: "/SourceAdmin/ashx/XuLyAdmin.ashx",
                    data: fd_data,
                    contentType: false,
                    processData: false,
                    success: function (kq) {
                        var data = JSON.parse(kq);
                        if (data.sucess) {
                            swal('Thông báo ', data.msg, 'success')
                            $('#preview').html('');
                            $('#anhdaidien').val('');
                            $('#name-vid').html('');
                            $('#size-vid').html('');
                            $('#type-vid').html('');

                            window.opener.getLinkFile(data.fileResponse);
                            window.close();
                        } else {
                            swal('Thông báo ', data.msg, 'error')
                        }
                    }
                });
            }
        });


        function renderFileOther(file) {
            var reader = new FileReader();
            reader.onload = function (event) {
                the_url = event.target.result
                $('#name-vid').html(file.name)
                $('#size-vid').html("Dung lượng : " + humanFileSizeVideo(file.size, "MB"))
                $('#kicthuoc').html(humanFileSizeVideo(file.size, "MB"))
            }
            reader.readAsDataURL(file);
        }

    </script>

    <script type="text/javascript">
        var page = 'filevanbanday';
    </script>
</body>
</html>
